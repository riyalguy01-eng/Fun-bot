import os
import random
from collections import defaultdict
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters
)

BOT_TOKEN = os.getenv("BOT_TOKEN")  # Set in Railway Variables

# ----- Storage -----
message_count = defaultdict(int)

# ----- Commands -----
async def start(update, context):
    await update.message.reply_text("Hello ğŸ‘‹ Iâ€™m your fun TG bot, running on Railway!")

async def help(update, context):
    commands = """
ğŸ¤– Commands:
/start - Greet
/help - Show commands
/joke - Random joke
/meme - Meme text
/roast - Savage roast
/compliment - Nice words
/stats - Message leaderboard
"""
    await update.message.reply_text(commands)

async def joke(update, context):
    jokes = [
        "Why donâ€™t bots panic? They always keep their cache ğŸ¤–",
        "Iâ€™d tell you a UDP joke, but you might not get it ğŸ“¡",
        "404 Joke not found ğŸ˜…"
    ]
    await update.message.reply_text(random.choice(jokes))

async def meme(update, context):
    memes = [
        "Me coding bots at 3 AM ğŸ¥´",
        "This group without me: ğŸ’¤",
        "AI be like: Iâ€™m not lazy, Iâ€™m energy-efficient âš¡"
    ]
    await update.message.reply_text(random.choice(memes))

async def roast(update, context):
    roasts = [
        "You bring people togetherâ€¦ by making them agree youâ€™re annoying ğŸ˜‚",
        "Somewhere, a tree is producing oxygen for you. I hope you apologize ğŸŒ³",
        "You have something on your faceâ€¦ oh wait, thatâ€™s just your face ğŸ’€"
    ]
    await update.message.reply_text(random.choice(roasts))

async def compliment(update, context):
    compliments = [
        "Your brain has more connections than WiFi ğŸŒ",
        "Youâ€™re proof that evolution sometimes works ğŸ’¡",
        "If vibes were money, youâ€™d be a billionaire âœ¨"
    ]
    await update.message.reply_text(random.choice(compliments))

async def stats(update, context):
    if not message_count:
        await update.message.reply_text("No messages tracked yet ğŸ“­")
        return
    leaderboard = sorted(message_count.items(), key=lambda x: x[1], reverse=True)
    text = "ğŸ“Š Message Leaderboard:\n"
    for user, count in leaderboard[:5]:
        text += f"{user}: {count} msgs\n"
    await update.message.reply_text(text)

# ----- Auto Reactions -----
async def track_and_react(update, context):
    user = update.effective_user.first_name
    message_count[user] += 1

    text = update.message.text.lower()

    # Word triggers
    triggers = {
        "chess": "â™Ÿï¸ Still thinking 20 minutes per move?",
        "bot": "Beep boop ğŸ¤–",
        "sleep": "Donâ€™t sleep, code bots instead âš¡"
    }
    for word, reply in triggers.items():
        if word in text:
            await update.message.reply_text(reply)
            break

    # Random sarcasm (10% chance)
    if random.random() < 0.1:
        sarcastic_replies = [
            "Wowâ€¦ groundbreaking message ğŸ™„",
            "This is why aliens avoid us ğŸ‘½",
            "Bro, even Google didnâ€™t ask for this ğŸ“‰"
        ]
        await update.message.reply_text(random.choice(sarcastic_replies))

# ----- Main -----
def main():
    app = Application.builder().token(BOT_TOKEN).build()

    # Command handlers
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help))
    app.add_handler(CommandHandler("joke", joke))
    app.add_handler(CommandHandler("meme", meme))
    app.add_handler(CommandHandler("roast", roast))
    app.add_handler(CommandHandler("compliment", compliment))
    app.add_handler(CommandHandler("stats", stats))

    # Message handler
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, track_and_react))

    print("Bot is runningâ€¦")
    app.run_polling()

if __name__ == "__main__":
    main()

